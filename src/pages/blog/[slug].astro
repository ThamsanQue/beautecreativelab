---
import Layout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";
import { getPostBySlug, getSettings } from "../../utils/api";
import { formatDate, getGhostImgPath } from "../../utils";

const settings = await getSettings();
const params = Astro.params;
const slug = params.slug;

// Fetch post data
let post;
try {
  post = await getPostBySlug(slug as string);
} catch (error) {
  if (error instanceof Error) {
    throw new Error(`Error fetching post: ${error.message}`);
  } else {
    throw new Error(`Error fetching post: ${error}`);
  }
}

if (!post) {
  throw new Error(`Post with slug "${slug}" not found.`);
}
---

<Layout title={post.title}>
  <main class="min-h-screen bg-[#faf9f7]">
    <!-- Hero Section -->
    <section class="px-4 md:px-8 lg:px-16 pt-24 pb-16">
      <div class="max-w-6xl mx-auto">
        <h1
          class="font-light text-5xl md:text-7xl text-neutral-900 mb-4 heading-xl"
        >
          {post.title}
        </h1>
        <div class="flex items-center space-x-4 mb-8 body-text">
          <Image
            src={`${getGhostImgPath(settings.url, post.primary_author?.profile_image || "", 300)}`}
            width={300}
            height={300}
            alt={(post.primary_author as any).name}
            class="w-10 h-10 rounded-full object-cover"
          />
          <p class="text-neutral-600 text-lg">
            {(post.primary_author as any).name}
          </p>
          <time
            class="text-neutral-500 text-sm"
            datetime={formatDate(post.published_at ?? "")}
          >
            {formatDate(post.published_at ?? "")}
          </time>
        </div>
        <div class="text-neutral-600 text-lg leading-relaxed body-text">
          <div set:html={post.html} />
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  gsap.from(".heading-xl", {
    y: 100,
    opacity: 0,
    duration: 1,
    ease: "power3.out",
    stagger: 0.2,
  });

  gsap.from(".body-text", {
    y: 30,
    opacity: 0,
    duration: 1,
    delay: 0.5,
    ease: "power3.out",
  });
</script>
